<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cyber Network Flow — Loader → Confirm → Upload → Server Map</title>

<!--
  ===================================================================
  Full single-file UI
  - Bright green / black cyber theme
  - Initial loader 0→100 (10s)
  - WiFi connected screen
  - IP confirm (Yes / No)
  - Uploading to servers (simulated)
  - Upload Successful -> shows server city name + world graphic with highlighted marker
  - 40 server cities (7 US + 33 worldwide)
  - World graphic: equirectangular map area clipped to a circle (stylized globe)
  - Markers placed by lat/lon -> converted into x,y using simple projection
  - Keyboard shortcuts: Y=Yes, N=No during confirm; C to cycle server on success; R to restart
  ===================================================================
-->

<style>
/* ===================================================================
   THEME COLORS & GLOBALS
   =================================================================== */
:root {
  --neon: #00ff66;
  --bg: #000;
  --panel: rgba(10,10,10,0.7);
  --glass: rgba(255,255,255,0.02);
  --muted: rgba(0,255,102,0.07);
  --glow: 0 0 12px rgba(0,255,102,0.18), 0 0 30px rgba(0,255,102,0.06);
  --accent: rgba(0,255,102,0.92);
  --font-main: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Basic reset */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; width: 100%; background: var(--bg); color: var(--neon); font-family: var(--font-main); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* Full app container centers everything */
.app {
  min-height: 100vh;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 28px;
  position: relative;
  overflow: hidden;
}

/* Decorative background layers to add depth */
.bg-grid {
  position: absolute;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  background:
    repeating-linear-gradient(0deg, rgba(0,255,102,0.06) 0px, rgba(0,255,102,0.06) 1px, transparent 1px, transparent 24px),
    repeating-linear-gradient(90deg, rgba(0,255,102,0.06) 0px, rgba(0,255,102,0.06) 1px, transparent 1px, transparent 24px);
  animation: gridMove 18s linear infinite;
  opacity: 0.75;
  filter: blur(1px);
}
@keyframes gridMove { from { background-position: 0 0, 0 0 } to { background-position: 60px 60px, 60px 60px } }

.bg-radial {
  position: absolute; inset: -20%; z-index: 0; pointer-events: none;
  background: radial-gradient(circle at 20% 30%, rgba(0,255,102,0.05), transparent 12%),
              radial-gradient(circle at 80% 70%, rgba(0,255,102,0.03), transparent 18%);
  filter: blur(28px);
}

/* Card that contains the UI (adds glass + glow) */
.card {
  position: relative;
  z-index: 2;
  width: min(1100px, 96%);
  max-width: 1200px;
  border-radius: 14px;
  padding: 26px;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.007));
  border: 1px solid rgba(0,255,102,0.04);
  box-shadow: 0 10px 50px rgba(0,0,0,0.65), var(--glow);
  display: flex;
  flex-direction: column;
  gap: 16px;
  align-items: center;
}

/* Header row - brand + small status text */
.header {
  width: 100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
}
.brand {
  display:flex; align-items:center; gap:12px; color: var(--neon); font-weight: 700; font-size: 16px;
  text-shadow: 0 0 8px rgba(0,255,102,0.14);
}
.brand .logo {
  width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, rgba(0,40,10,0.6), rgba(0,150,50,0.12));
  box-shadow: inset 0 -6px 24px rgba(0,0,0,0.5);
  font-weight:800; color: rgba(0,255,102,0.92);
}

.statusTiny { color: rgba(0,255,102,0.14); font-size: 12px; }

/* layout area splits left (big visual area) and right (controls/info) */
.layout {
  width: 100%;
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 22px;
  align-items: start;
}

/* left column card area */
.leftArea {
  min-height: 420px;
  border-radius: 10px;
  padding: 18px;
  background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(255,255,255,0.01));
  border: 1px solid rgba(0,255,102,0.02);
  box-shadow: inset 0 -6px 20px rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
  gap: 10px;
  align-items:center;
  justify-content:center;
}

/* right column area for steps/details */
.rightArea {
  min-height: 420px;
  border-radius: 10px;
  padding: 18px;
  background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.008));
  border: 1px solid rgba(0,255,102,0.02);
  display:flex;
  flex-direction:column;
  gap: 12px;
  align-items:stretch;
  justify-content:flex-start;
}

/* small instruction / step item */
.step {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid rgba(0,255,102,0.03);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.12));
  color: rgba(0,255,102,0.9);
  font-size: 13px;
  display:flex;
  gap:10px;
  align-items:center;
}

/* ============================================================
   LOADING VIEW - spinner + bar + tips
   ============================================================ */
.loaderBlock {
  width: 100%;
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:center;
  justify-content:center;
}

/* circular spinner with inner text */
.spinner {
  width: 110px; height: 110px; border-radius: 50%;
  background: linear-gradient(180deg, rgba(0,0,0,0.5), rgba(255,255,255,0.02));
  border: 4px solid rgba(255,255,255,0.02);
  display:grid; place-items:center;
  box-shadow: var(--glow);
  position:relative;
}
.spinner::after {
  content: "";
  position:absolute; inset:14px; border-radius:50%;
  border: 7px solid rgba(0,0,0,0.55); border-top-color: var(--neon);
  animation: spin 0.95s linear infinite;
}
@keyframes spin { from { transform: rotate(0) } to { transform: rotate(360deg) } }

.progressWrap {
  width: 92%;
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:center;
}
.progressBarOuter {
  width:100%;
  height: 18px;
  background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.007));
  border-radius: 12px;
  padding: 3px;
  border: 1px solid rgba(0,255,102,0.02);
}
.progressBarInner {
  width: 0%;
  height: 100%;
  border-radius: 10px;
  background: linear-gradient(90deg, rgba(0,255,102,0.95), rgba(0,160,80,0.9));
  box-shadow: 0 8px 30px rgba(0,255,102,0.06);
  transition: width 0.09s linear;
}
.percentText {
  font-weight: 800;
  font-size: 18px;
  color: var(--neon);
  text-shadow: 0 0 8px rgba(0,255,102,0.12);
}
.tipText {
  font-style: italic;
  color: rgba(0,255,102,0.9);
  font-size: 13px;
  opacity: 0.95;
}

/* small metadata row under loader */
.metaRow {
  width: 92%; display:flex; justify-content:space-between; color: rgba(0,255,102,0.18); font-size: 12px;
}

/* ============================================================
   CONNECTED VIEW
   ============================================================ */
.connectedView {
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:center;
  justify-content:center;
  padding:6px;
  transform-origin:center;
}
.checkPulse {
  font-size: 56px;
  color: var(--neon);
  text-shadow: var(--glow);
  animation: pulse 1.4s ease-in-out infinite;
}
@keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1)} }
.wifiBars { display:flex; align-items:flex-end; gap:6px; margin-top:6px; }
.wifiBars .bar { width:12px; border-radius:3px; background:var(--neon); box-shadow:var(--glow); transform-origin:bottom center; animation: barWave 1s ease-in-out infinite; }
.wifiBars .b1 { height: 12px; animation-delay: 0s; } .wifiBars .b2 { height: 20px; animation-delay: 0.12s; } .wifiBars .b3 { height: 28px; animation-delay: 0.24s; } .wifiBars .b4 { height: 36px; animation-delay: 0.36s; }
@keyframes barWave { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(1.3)} }

/* headline flicker */
.headlineFlicker { font-size:22px; font-weight:700; color:var(--neon); text-shadow: var(--glow); animation: flick 2.6s infinite; }
@keyframes flick { 0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity:1 } 20%,22%,24%,55% { opacity:0.38 } }

/* ============================================================
   IP CONFIRM VIEW
   ============================================================ */
.ipCard {
  width:100%;
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:center;
  padding:14px;
  border-radius:10px;
  background: linear-gradient(180deg, rgba(0,255,102,0.01), rgba(255,255,255,0.01));
  border: 1px solid rgba(0,255,102,0.03);
}
.ipValue {
  font-weight:800; font-size:20px; color:var(--neon); text-shadow: 0 0 10px rgba(0,255,102,0.06);
}
.subInfo { color: rgba(0,255,102,0.66); font-size: 13px; }

.btnRow { display:flex; gap: 12px; margin-top:6px; }
.btn {
  padding:10px 16px; border-radius: 10px; border: 1px solid rgba(0,255,102,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.14));
  color: var(--neon); font-weight:800; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease;
}
.btn:hover { transform: translateY(-3px); box-shadow: 0 14px 40px rgba(0,255,102,0.06); }
.btn.secondary { opacity: 0.86; }

/* ============================================================
   UPLOADING VIEW
   ============================================================ */
.uploadingCard { display:flex; flex-direction:column; gap:12px; align-items:center; width:100%; padding:12px; }
.uploadBarWrap { width: 92%; background: rgba(255,255,255,0.01); padding: 6px; border-radius: 12px; border: 1px solid rgba(0,255,102,0.02); }
.uploadBarFill { width: 0%; height: 14px; border-radius: 10px; background: linear-gradient(90deg, rgba(0,255,102,0.95), rgba(0,160,80,0.9)); transition: width .08s linear; box-shadow: var(--glow); }
.uploadState { font-size: 13px; color: rgba(0,255,102,0.9); font-weight:700; }

/* cancel button */
.cancelBtn { padding:8px 12px; border-radius:8px; border:1px solid rgba(0,255,102,0.06); background: transparent; cursor:pointer; color:var(--neon); }

/* ============================================================
   UPLOAD SUCCESS + WORLD MAP GRAPHIC
   - Name of server above map
   - SVG globe (equirect grid clipped to circle)
   - Markers placed by converting lat/lon to x,y inside map rectangle
   ============================================================ */

/* success panel */
.successPanel { display:flex; flex-direction:column; gap:10px; align-items:center; width:100%; }
.successTitle { font-size:20px; font-weight:900; color:var(--neon); text-shadow:var(--glow); }
.serverName { font-size:18px; font-weight:800; color:var(--neon); text-shadow:0 0 8px rgba(0,255,102,0.08); }

/* SVG container styling */
.mapWrap {
  width: 92%;
  max-width: 920px;
  background: linear-gradient(180deg, rgba(0,0,0,0.36), rgba(255,255,255,0.003));
  border-radius: 12px;
  padding: 10px;
  border: 1px solid rgba(0,255,102,0.03);
  display:flex;
  justify-content:center;
  align-items:center;
}

/* inside the svg we clip an equirectangular rectangle to a circle */
svg { display:block; width:100%; height:auto; }

/* marker style */
.marker { fill: var(--neon); stroke: rgba(0,0,0,0.4); stroke-width:1; filter: drop-shadow(0 8px 22px rgba(0,255,102,0.08)); }
.markerPulse {
  transform-origin: center;
  animation: markerPulse 1.6s infinite;
}
@keyframes markerPulse {
  0% { transform: scale(1); opacity: 1 }
  50% { transform: scale(1.6); opacity: 0.45 }
  100% { transform: scale(1); opacity: 1 }
}

/* tooltip style */
.tooltip {
  background: rgba(0,0,0,0.7);
  border-radius: 6px;
  padding:6px 8px;
  border: 1px solid rgba(0,255,102,0.06);
  font-size: 13px;
  color: var(--neon);
  box-shadow: var(--glow);
}

/* helper text below map */
.mapHint { color: rgba(0,255,102,0.6); font-size: 13px; }

/* tiny footer */
.footerHint { margin-top: 6px; color: rgba(0,255,102,0.12); font-size: 12px; }

/* responsive */
@media (max-width: 980px) { .layout { grid-template-columns: 1fr; } .rightArea { order: 2; } .leftArea { order: 1; } }
</style>
</head>
<body>
  <div class="app">
    <div class="bg-grid"></div>
    <div class="bg-radial"></div>

    <div class="card" role="main" aria-live="polite">
      <div class="header" role="banner">
        <div class="brand"><div class="logo">GD</div> GearDriven — Network Flow Simulator</div>
        <div class="statusTiny">Demo • Press Y (yes) or N (no) on confirm</div>
      </div>

      <div class="layout">

        <!-- LEFT: Big visual / map area (also shows loader, connected, success map) -->
        <div class="leftArea">

          <!-- LOADER BLOCK -->
          <div id="leftLoader" class="loaderBlock" aria-hidden="false">
            <div class="spinner" aria-hidden="true">
              <div style="font-size:12px;color:var(--neon);font-weight:700">CONNECTING</div>
            </div>

            <div class="progressWrap">
              <div class="progressBarOuter">
                <div id="mainProgress" class="progressBarInner" style="width:0%"></div>
              </div>
              <div class="percentText" id="mainPercent">0%</div>
              <div class="tipText" id="mainTip">Initializing connection...</div>
              <div class="metaRow"><div>Protocol: WPA3</div><div id="eta">ETA: 10s</div></div>
            </div>
          </div>

          <!-- CONNECTED BLOCK (brief) -->
          <div id="leftConnected" class="connectedView" aria-hidden="true" style="display:none">
            <div class="checkPulse">✔</div>
            <div class="wifiBars" aria-hidden="true">
              <div class="bar b1"></div><div class="bar b2"></div><div class="bar b3"></div><div class="bar b4"></div>
            </div>
            <div class="headlineFlicker">WiFi Connected</div>
            <div class="subInfo" style="color:rgba(0,255,102,0.7)">Preparing network details…</div>
          </div>

          <!-- UPLOADING BLOCK -->
          <div id="leftUploading" class="uploadingCard" aria-hidden="true" style="display:none">
            <div style="font-weight:900;color:var(--neon)">Uploading to servers</div>
            <div style="color:rgba(0,255,102,0.6);font-size:13px">Secure transfer — do not close</div>
            <div class="uploadBarWrap"><div id="uploadFill" class="uploadBarFill" style="width:0%"></div></div>
            <div style="width:92%;display:flex;justify-content:space-between"><div id="uploadState" class="uploadState">Initializing...</div><div id="uploadPct" style="color:var(--neon)">0%</div></div>
            <div style="display:flex;gap:8px"><button id="cancelUpload" class="cancelBtn">Cancel</button></div>
          </div>

          <!-- UPLOAD SUCCESS + MAP -->
          <div id="leftSuccess" class="successPanel" aria-hidden="true" style="display:none">
            <div class="successTitle">Upload Successful</div>
            <div class="serverName" id="serverName">Server: —</div>

            <!-- Map wrapper: contains SVG globe (grid clipped to circle) -->
            <div class="mapWrap" id="mapWrap" role="img" aria-label="World map showing server location">
              <!-- SVG width responsive; inside we draw a rectangular map area then clip it to circle -->
              <svg id="worldSvg" viewBox="0 0 900 450" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                <!-- background rectangle (equirectangular area) -->
                <defs>
                  <!-- circular clip so the rectangle appears as a globe -->
                  <clipPath id="globeClip">
                    <circle cx="450" cy="225" r="200" />
                  </clipPath>

                  <!-- subtle map shading -->
                  <radialGradient id="oceanGrad" cx="50%" cy="40%">
                    <stop offset="0%" stop-color="#021005" stop-opacity="0.55"/>
                    <stop offset="100%" stop-color="#001400" stop-opacity="0.92"/>
                  </radialGradient>

                  <!-- faint lat/lon grid lines pattern -->
                  <pattern id="gridLines" width="36" height="36" patternUnits="userSpaceOnUse">
                    <path d="M 0 0 L 36 0" stroke="rgba(0,255,102,0.04)" stroke-width="0.8"></path>
                    <path d="M 0 0 L 0 36" stroke="rgba(0,255,102,0.04)" stroke-width="0.8"></path>
                  </pattern>

                  <filter id="markerShadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feDropShadow dx="0" dy="6" stdDeviation="10" flood-color="rgba(0,255,102,0.08)"/>
                  </filter>
                </defs>

                <!-- dark circular backdrop for globe -->
                <circle cx="450" cy="225" r="205" fill="rgba(0,0,0,0.45)" stroke="rgba(0,255,102,0.05)" stroke-width="2" />
                <g clip-path="url(#globeClip)">
                  <!-- ocean rectangle (equirectangular) - covers world extent -->
                  <rect x="50" y="50" width="800" height="300" fill="url(#oceanGrad)"></rect>

                  <!-- faint grid overlay -->
                  <rect x="50" y="50" width="800" height="300" fill="url(#gridLines)" opacity="0.12"></rect>

                  <!-- equator and prime meridian lines -->
                  <path d="M50 200 L850 200" stroke="rgba(0,255,102,0.06)" stroke-width="1.2" />
                  <path d="M450 50 L450 350" stroke="rgba(0,255,102,0.06)" stroke-width="1.2" />

                  <!-- decorative continent silhouettes (stylized blobs) -->
                  <!-- NOTE: these are abstract shapes to hint continents, not precise coastlines -->
                  <g fill="rgba(0,0,0,0.18)" stroke="rgba(0,255,102,0.03)">
                    <path d="M120 170 C150 140 220 120 300 130 C360 135 390 160 420 170 C460 183 520 190 570 170 C630 150 700 150 740 170 L740 260 C680 240 620 250 560 260 C500 270 430 260 370 260 C300 260 220 250 160 240 Z" opacity="0.28"/>
                    <path d="M170 220 C185 200 220 200 260 210 C295 218 325 235 360 240 C380 244 330 260 300 260 C260 260 210 250 180 245 Z" opacity="0.16"></path>
                    <path d="M520 120 C540 100 580 98 620 110 C650 120 680 140 720 148 L740 150 L740 170" opacity="0.1"/>
                    <path d="M280 300 C320 290 360 300 400 310 C460 325 520 330 590 320 C620 315 680 310 740 300 L740 260 C700 270 660 274 620 274 C560 274 520 268 480 260 C430 250 380 245 320 250 C280 254 250 272 220 282 Z" opacity="0.12"></path>
                  </g>

                  <!-- markers group (populated by JS) -->
                  <g id="markers"></g>

                </g>

                <!-- thin ring and subtle highlights outside clip -->
                <circle cx="450" cy="225" r="202" fill="none" stroke="rgba(0,255,102,0.04)" stroke-width="1.2"/>
              </svg>
            </div>

            <div class="mapHint">Highlighted marker indicates the server city.</div>
            <div class="footerHint">Press C to cycle server location (debug). Press R to restart flow.</div>
          </div>

        </div><!-- end left area -->

        <!-- RIGHT: Controls, info, confirm, steps -->
        <div class="rightArea">

          <!-- Step 1: Loader info -->
          <div class="step">
            <div style="font-weight:800">Step 1:</div>
            <div style="opacity:0.9">Connect to WiFi (automatic)</div>
          </div>

          <!-- Step 2: Confirmation area -->
          <div class="step">
            <div style="font-weight:800">Step 2:</div>
            <div style="opacity:0.9">Confirm assigned IP and throughput</div>
          </div>

          <!-- IP Confirm control box (changes content dynamically) -->
          <div id="confirmBox" class="ipCard" style="display:none">
            <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800;color:var(--neon)">Confirm Connection</div>
              <div style="font-size:12px;color:rgba(0,255,102,0.22)">Step 2 of 3</div>
            </div>

            <div style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:linear-gradient(90deg, rgba(0,0,0,0.25), rgba(255,255,255,0.01));border:1px solid rgba(0,255,102,0.03)">
              <div>
                <div class="ipValue" id="ipDisplay">192.168.0.101</div>
                <div class="subInfo" id="speedDisplay">200 Mbps</div>
              </div>
              <div style="color:rgba(0,255,102,0.22);font-size:12px">Private IP</div>
            </div>

            <div style="margin-top:10px">Is this information correct?</div>
            <div class="btnRow" style="margin-top:8px">
              <button id="confirmYes" class="btn">YES — Confirm</button>
              <button id="confirmNo" class="btn secondary">NO — Reset</button>
            </div>
            <div style="font-size:12px;color:rgba(0,255,102,0.32)">Tip: press Y for Yes, N for No</div>
          </div>

          <!-- Upload status summary -->
          <div id="uploadBox" style="display:none">
            <div class="step" style="display:flex;flex-direction:column;gap:6px">
              <div style="font-weight:800">Uploading</div>
              <div style="color:rgba(0,255,102,0.48);font-size:13px" id="uploadSummary">Preparing secure channel</div>
            </div>
            <div style="margin-top:6px">
              <div class="uploadBarWrap"><div id="uploadBarRight" class="uploadBarFill" style="width:0%"></div></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
              <div id="uploadStateRight" class="uploadState">Starting...</div>
              <div id="uploadPctRight" style="color:var(--neon)">0%</div>
            </div>
            <div style="margin-top:10px">
              <button id="cancelBtnRight" class="btn secondary">Cancel & Restart</button>
            </div>
          </div>

          <!-- final success summary -->
          <div id="finalBox" style="display:none" class="step">
            <div style="font-weight:800">Final</div>
            <div id="finalSummary" style="color:rgba(0,255,102,0.9)">Upload successful and server selected.</div>
          </div>

        </div><!-- end right area -->

      </div><!-- end layout -->

    </div><!-- end card -->
  </div><!-- end app -->

<script>
/* =========================================================================
   Long interactive JS controlling the flow.

   Flow overview:
   1) start() -> starts loader 0->100 in 10s (100 steps at 100ms)
   2) on complete -> show connected briefly (2.2s)
   3) show confirm UI with randomized IP & speed
   4) if YES -> show uploading (simulated 5s) -> on complete show success
      and display server city name + highlight marker on map
   5) if NO -> restart the flow with new randoms
   6) On success we DO NOT auto-reset; user can press R to restart OR we can auto-advance later
   7) Extra convenience keys: Y, N, C (cycle server), R (restart)

   Additionally:
   - The "world" graphic is an SVG rectangle representing longitudes -180..+180 and latitudes +90..-90,
     mapped to x,y inside the rectangle, then clipped to a circle to look globe-like.
   - Marker positions are computed from lat/lon using equirectangular mapping:
       x = left + (lon + 180) / 360 * width
       y = top + (90 - lat) / 180 * height
   - This is not a projection-correct map (no distortion handling) but visually accurate enough for markers.
   ========================================================================= */

/* -------------------------
   DOM references
-------------------------- */
const leftLoader = document.getElementById('leftLoader');
const leftConnected = document.getElementById('leftConnected');
const leftUploading = document.getElementById('leftUploading');
const leftSuccess = document.getElementById('leftSuccess');

const mainProgress = document.getElementById('mainProgress');
const mainPercent = document.getElementById('mainPercent');
const mainTip = document.getElementById('mainTip');
const etaEl = document.getElementById('eta');

const ipDisplay = document.getElementById('ipDisplay');
const speedDisplay = document.getElementById('speedDisplay');
const confirmBox = document.getElementById('confirmBox');

const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

const uploadFill = document.getElementById('uploadFill');
const uploadState = document.getElementById('uploadState');
const uploadPct = document.getElementById('uploadPct');

const uploadBox = document.getElementById('uploadBox');
const uploadBarRight = document.getElementById('uploadBarRight');
const uploadStateRight = document.getElementById('uploadStateRight');
const uploadPctRight = document.getElementById('uploadPctRight');
const cancelBtnRight = document.getElementById('cancelBtnRight');

const serverNameEl = document.getElementById('serverName');
const markersGroup = document.getElementById('markers');
const worldSvg = document.getElementById('worldSvg');

const finalBox = document.getElementById('finalBox');
const finalSummary = document.getElementById('finalSummary');

/* -------------------------
   Core state
-------------------------- */
let loaderInterval = null;
let tipInterval = null;
let uploadInterval = null;
let uploadStateTimer = null;

let percent = 0;
let ipAssigned = '';
let speedAssigned = '';
let selectedServerIndex = -1; // which city is selected on success

/* -------------------------
   Tip pool
-------------------------- */
const tips = [
  "Checking network interface...",
  "Scanning for known SSIDs...",
  "Decrypting handshake (simulated)...",
  "Pinging local gateway...",
  "Verifying DNS entries...",
  "Negotiating bandwidth parameters...",
  "Optimizing signal path...",
  "Applying regional settings...",
  "Refreshing ARP table...",
  "Finalizing network handshake..."
];

/* -------------------------
   Server city data (40 locations)
   Each entry: { name, lat, lon }
   (approx lat/lon — close enough for marker plotting)
   7 US cities first, then worldwide
-------------------------- */
const serverCities = [
  { name: "New York, USA", lat: 40.7128, lon: -74.0060 },
  { name: "Los Angeles, USA", lat: 34.0522, lon: -118.2437 },
  { name: "Chicago, USA", lat: 41.8781, lon: -87.6298 },
  { name: "Houston, USA", lat: 29.7604, lon: -95.3698 },
  { name: "Phoenix, USA", lat: 33.4484, lon: -112.0740 },
  { name: "Philadelphia, USA", lat: 39.9526, lon: -75.1652 },
  { name: "San Francisco, USA", lat: 37.7749, lon: -122.4194 },

  { name: "Toronto, Canada", lat: 43.6532, lon: -79.3832 },
  { name: "Vancouver, Canada", lat: 49.2827, lon: -123.1207 },
  { name: "Mexico City, Mexico", lat: 19.4326, lon: -99.1332 },

  { name: "London, UK", lat: 51.5074, lon: -0.1278 },
  { name: "Manchester, UK", lat: 53.4808, lon: -2.2426 },
  { name: "Paris, France", lat: 48.8566, lon: 2.3522 },
  { name: "Berlin, Germany", lat: 52.5200, lon: 13.4050 },
  { name: "Munich, Germany", lat: 48.1351, lon: 11.5820 },
  { name: "Madrid, Spain", lat: 40.4168, lon: -3.7038 },
  { name: "Rome, Italy", lat: 41.9028, lon: 12.4964 },
  { name: "Amsterdam, Netherlands", lat: 52.3676, lon: 4.9041 },
  { name: "Brussels, Belgium", lat: 50.8503, lon: 4.3517 },
  { name: "Zurich, Switzerland", lat: 47.3769, lon: 8.5417 },

  { name: "Vienna, Austria", lat: 48.2082, lon: 16.3738 },
  { name: "Stockholm, Sweden", lat: 59.3293, lon: 18.0686 },
  { name: "Oslo, Norway", lat: 59.9139, lon: 10.7522 },
  { name: "Copenhagen, Denmark", lat: 55.6761, lon: 12.5683 },
  { name: "Warsaw, Poland", lat: 52.2297, lon: 21.0122 },

  { name: "Prague, Czech Republic", lat: 50.0755, lon: 14.4378 },
  { name: "Budapest, Hungary", lat: 47.4979, lon: 19.0402 },
  { name: "Athens, Greece", lat: 37.9838, lon: 23.7275 },
  { name: "Istanbul, Turkey", lat: 41.0082, lon: 28.9784 },

  { name: "Dubai, UAE", lat: 25.2048, lon: 55.2708 },
  { name: "Doha, Qatar", lat: 25.2854, lon: 51.5310 },

  { name: "Mumbai, India", lat: 19.0760, lon: 72.8777 },
  { name: "Singapore", lat: 1.3521, lon: 103.8198 },
  { name: "Hong Kong", lat: 22.3193, lon: 114.1694 },

  { name: "Tokyo, Japan", lat: 35.6762, lon: 139.6503 },
  { name: "Osaka, Japan", lat: 34.6937, lon: 135.5023 },

  { name: "Sydney, Australia", lat: -33.8688, lon: 151.2093 },
  { name: "Melbourne, Australia", lat: -37.8136, lon: 144.9631 },
  { name: "Auckland, New Zealand", lat: -36.8485, lon: 174.7633 }
];

/* -------------------------
   Utility helpers
-------------------------- */
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function chooseRandom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

/* produce private-ish IP in 192.168.x.y range for realism */
function produceRandomIP() {
  const a = 192, b = 168, c = randInt(0,255), d = randInt(1,254);
  return `${a}.${b}.${c}.${d}`;
}

/* choose a realistic Mbps value */
function produceRandomSpeed() {
  const choices = [50, 75, 100, 150, 200, 250, 300, 400, 500, 750, 1000];
  const pick = choices[randInt(0, choices.length-1)];
  return `${pick} Mbps`;
}

/* -------------------------
   Map coordinate conversion
   - We map equirectangular lon/lat to rectangle coordinates used in the SVG:
     rectangle covers longitudes -180..+180 and latitudes +90..-90
     rectangle has left=50, top=50, width=800, height=300 (as used in the SVG)
     formula:
       x = left + (lon + 180) / 360 * width
       y = top + (90 - lat) / 180 * height
-------------------------- */
const MAP_LEFT = 50, MAP_TOP = 50, MAP_WIDTH = 800, MAP_HEIGHT = 300;
function lonLatToXY(lon, lat) {
  const x = MAP_LEFT + ((lon + 180) / 360) * MAP_WIDTH;
  const y = MAP_TOP + ((90 - lat) / 180) * MAP_HEIGHT;
  return { x, y };
}

/* -------------------------
   Create markers SVG elements for all cities (hidden by default)
   We'll create group <g> elements containing a pulsing circle + tooltip text
-------------------------- */
function buildMarkers() {
  markersGroup.innerHTML = ''; // clear
  serverCities.forEach((city, idx) => {
    const { x, y } = lonLatToXY(city.lon, city.lat);
    // create group
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.setAttribute("data-idx", idx);
    g.setAttribute("transform", `translate(${x},${y})`);
    g.style.cursor = "pointer";

    // pulsing circle (visual halo)
    const pulse = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    pulse.setAttribute("r", 12);
    pulse.setAttribute("class", "markerPulse");
    pulse.setAttribute("fill", "rgba(0,255,102,0.12)");
    pulse.setAttribute("stroke", "none");
    pulse.setAttribute("opacity", "0.9");

    // small solid dot
    const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    dot.setAttribute("r", 5);
    dot.setAttribute("class", "marker");
    dot.setAttribute("filter", "url(#markerShadow)");

    // label (hidden by default) — simple tooltip like text
    const labelBg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    labelBg.setAttribute("x", 14); labelBg.setAttribute("y", -12);
    labelBg.setAttribute("width", 160); labelBg.setAttribute("height", 24);
    labelBg.setAttribute("rx", 6); labelBg.setAttribute("ry", 6);
    labelBg.setAttribute("fill", "rgba(0,0,0,0.7)");
    labelBg.setAttribute("stroke", "rgba(0,255,102,0.04)");
    labelBg.setAttribute("visibility", "hidden");

    const labelText = document.createElementNS("http://www.w3.org/2000/svg", "text");
    labelText.setAttribute("x", 22); labelText.setAttribute("y", 6);
    labelText.setAttribute("fill", "var(--neon)");
    labelText.setAttribute("font-size", "12px");
    labelText.setAttribute("visibility", "hidden");
    labelText.textContent = city.name;

    // on hover show label
    g.addEventListener('mouseenter', () => {
      labelBg.setAttribute("visibility", "visible");
      labelText.setAttribute("visibility", "visible");
    });
    g.addEventListener('mouseleave', () => {
      labelBg.setAttribute("visibility", "hidden");
      labelText.setAttribute("visibility", "hidden");
    });

    // on click, set selected server
    g.addEventListener('click', () => {
      selectServerIndex(idx);
    });

    // append shapes
    g.appendChild(pulse);
    g.appendChild(dot);
    g.appendChild(labelBg);
    g.appendChild(labelText);

    // attach to markers group
    markersGroup.appendChild(g);
  });
}

/* -------------------------
   Highlight chosen server marker
   - add pulsing visual emphasis and scroll map focus if necessary
-------------------------- */
function highlightSelectedMarker(idx) {
  // remove existing highlight classes
  const all = markersGroup.querySelectorAll('g');
  all.forEach(g => {
    const pulse = g.querySelector('circle.markerPulse');
    if (pulse) pulse.setAttribute('fill', 'rgba(0,255,102,0.12)');
    const dot = g.querySelector('.marker');
    if (dot) dot.setAttribute('r', 5);
  });

  // highlight target
  const target = markersGroup.querySelector(`g[data-idx='${idx}']`);
  if (!target) return;
  const pulse = target.querySelector('circle.markerPulse');
  if (pulse) pulse.setAttribute('fill', 'rgba(0,255,102,0.24)');
  const dot = target.querySelector('.marker');
  if (dot) dot.setAttribute('r', 7);

  // ensure label visible for a short time
  const labelBg = target.querySelector('rect');
  const labelText = target.querySelector('text');
  if (labelBg && labelText) {
    labelBg.setAttribute('visibility', 'visible');
    labelText.setAttribute('visibility', 'visible');
    setTimeout(() => { labelBg.setAttribute('visibility','hidden'); labelText.setAttribute('visibility','hidden'); }, 3200);
  }
}

/* -------------------------
   Select server index (set UI text and highlight)
-------------------------- */
function selectServerIndex(idx) {
  if (idx < 0 || idx >= serverCities.length) return;
  selectedServerIndex = idx;
  const city = serverCities[idx];
  serverNameEl.textContent = `Server: ${city.name}`;
  highlightSelectedMarker(idx);
}

/* -------------------------
   Cycle server (debug convenience)
-------------------------- */
function cycleServer() {
  const next = (selectedServerIndex + 1) % serverCities.length;
  selectServerIndex(next);
}

/* -------------------------
   Build and prepare markers once on load
-------------------------- */
buildMarkers();

/* -------------------------
   Flow Control: start -> connected -> confirm -> upload -> success
-------------------------- */

/* Start initial loader */
function startFlow() {
  // clear arithmetic intervals if any
  if (loaderInterval) { clearInterval(loaderInterval); loaderInterval = null; }
  if (tipInterval) { clearInterval(tipInterval); tipInterval = null; }
  if (uploadInterval) { clearInterval(uploadInterval); uploadInterval = null; }
  if (uploadStateTimer) { clearInterval(uploadStateTimer); uploadStateTimer = null; }

  // reset UI visibility
  leftLoader.style.display = 'flex';
  leftConnected.style.display = 'none';
  leftUploading.style.display = 'none';
  leftSuccess.style.display = 'none';
  confirmBox.style.display = 'none';
  uploadBox.style.display = 'none';
  finalBox.style.display = 'none';

  percent = 0;
  mainProgress.style.width = '0%';
  mainPercent.textContent = '0%';
  mainTip.textContent = 'Initializing connection...';
  etaEl.textContent = 'ETA: 10s';

  // produce IP and speed for this run
  ipAssigned = produceRandomIP();
  speedAssigned = produceRandomSpeed();

  // update right side confirmBox fields when ready
  ipDisplay.textContent = ipAssigned;
  speedDisplay.textContent = speedAssigned;

  // start rotating tips
  let tipIndex = 0;
  tipInterval = setInterval(() => {
    mainTip.textContent = tips[tipIndex % tips.length];
    tipIndex++;
  }, 1000);

  // start progress - 100 steps * 100ms = 10 seconds
  loaderInterval = setInterval(() => {
    percent++;
    mainProgress.style.width = percent + '%';
    mainPercent.textContent = percent + '%';

    // simple ETA (seconds left)
    const remainingSec = Math.max(0, Math.ceil((100 - percent) / 10));
    etaEl.textContent = `ETA: ${remainingSec}s`;

    if (percent >= 100) {
      clearInterval(loaderInterval);
      clearInterval(tipInterval);
      loaderInterval = null;
      tipInterval = null;
      // small delay then show connected
      setTimeout(showConnected, 200);
    }
  }, 100);
}

/* show connected briefly */
function showConnected() {
  leftLoader.style.display = 'none';
  leftConnected.style.display = 'flex';

  // after ~2.2s show confirm
  setTimeout(() => {
    leftConnected.style.display = 'none';
    showConfirm();
  }, 2200);
}

/* show confirm UI */
function showConfirm() {
  confirmBox.style.display = 'block';
  leftLoader.style.display = 'none';
  leftConnected.style.display = 'none';
  leftUploading.style.display = 'none';
  leftSuccess.style.display = 'none';
  uploadBox.style.display = 'none';
  finalBox.style.display = 'none';

  ipDisplay.textContent = ipAssigned;
  speedDisplay.textContent = speedAssigned;

  // focus yes button for keyboard use
  setTimeout(()=> confirmYes.focus(), 50);
}

/* confirm yes handler -> start upload */
function onConfirmYes() {
  confirmBox.style.display = 'none';
  leftUploading.style.display = 'flex';
  uploadBox.style.display = 'block';
  leftLoader.style.display = 'none';
  leftConnected.style.display = 'none';
  leftSuccess.style.display = 'none';
  finalBox.style.display = 'none';

  // start upload simulation
  startUploadSimulation();
}

/* confirm no handler -> restart flow */
function onConfirmNo() {
  confirmBox.style.display = 'none';
  // small flash or delay for perceived responsiveness
  setTimeout(() => {
    startFlow();
  }, 250);
}

/* -------------------------
   Upload simulation
   - We'll simulate states and fill from 0->100 in ~5s (100 steps * 50ms)
-------------------------- */
function startUploadSimulation() {
  let up = 0;
  uploadFill.style.width = '0%';
  uploadPct.textContent = '0%';
  uploadBarRight.style.width = '0%';
  uploadPctRight.textContent = '0%';
  uploadState.textContent = 'Initializing secure channel...';
  uploadStateRight.textContent = 'Initializing secure channel...';
  uploadBox.style.display = 'block';
  finalBox.style.display = 'none';

  const states = [
    "Initializing secure channel...",
    "Encrypting payload...",
    "Connecting to remote node...",
    "Transmitting packets...",
    "Verifying checksum...",
    "Finalizing transaction..."
  ];
  let stateIndex = 0;
  uploadState.textContent = states[stateIndex];
  uploadStateRight.textContent = states[stateIndex];

  uploadStateTimer = setInterval(()=> {
    stateIndex = Math.min(states.length-1, stateIndex+1);
    uploadState.textContent = states[stateIndex];
    uploadStateRight.textContent = states[stateIndex];
  }, 900);

  uploadInterval = setInterval(()=> {
    up++;
    if (up > 100) up = 100;
    uploadFill.style.width = up + '%';
    uploadPct.textContent = up + '%';
    uploadBarRight.style.width = up + '%';
    uploadPctRight.textContent = up + '%';

    if (up >= 100) {
      clearInterval(uploadInterval);
      clearInterval(uploadStateTimer);
      uploadInterval = null;
      uploadStateTimer = null;

      // show success screen (and map)
      setTimeout(() => {
        showUploadSuccess();
      }, 420);
    }
  }, 50);

  // cancel behavior: cancel button restarts flow
  const onCancel = () => {
    if (uploadInterval) { clearInterval(uploadInterval); uploadInterval = null; }
    if (uploadStateTimer) { clearInterval(uploadStateTimer); uploadStateTimer = null; }
    // hide upload UI then restart
    uploadBox.style.display = 'none';
    leftUploading.style.display = 'none';
    leftSuccess.style.display = 'none';
    setTimeout(()=> startFlow(), 200);
  };

  // attach cancel to both cancel controls
  const cancelEl = document.getElementById('cancelUpload');
  cancelEl.onclick = onCancel;
  cancelBtnRight.onclick = onCancel;
}

/* -------------------------
   On upload success -> select a random server and show map
-------------------------- */
function showUploadSuccess() {
  leftUploading.style.display = 'none';
  uploadBox.style.display = 'none';
  leftSuccess.style.display = 'flex';
  finalBox.style.display = 'block';
  finalSummary.textContent = 'Upload complete — server chosen.';

  // pick random server
  const idx = randInt(0, serverCities.length - 1);
  selectServerIndex(idx);
}

/* -------------------------
   selectServerIndex: choose and highlight
-------------------------- */
function selectServerIndex(idx) {
  selectedServerIndex = idx;
  const city = serverCities[idx];
  serverNameEl.textContent = `Server: ${city.name}`;
  highlightSelectedMarker(idx);
}

/* -------------------------
   keyboard convenience keys
-------------------------- */
document.addEventListener('keydown', (e) => {
  if (confirmBox.style.display === 'block') {
    if (e.key === 'y' || e.key === 'Y' || e.key === 'Enter') { confirmYes.click(); }
    if (e.key === 'n' || e.key === 'N' || e.key === 'Escape') { confirmNo.click(); }
  }

  if (leftSuccess.style.display === 'flex') {
    if (e.key === 'c' || e.key === 'C') { cycleServer(); }
    if (e.key === 'r' || e.key === 'R') { startFlow(); }
  }
});

/* -------------------------
   Wire up button handlers
-------------------------- */
confirmYes.addEventListener('click', onConfirmYes);
confirmNo.addEventListener('click', onConfirmNo);

/* -------------------------
   Start the initial run on load
-------------------------- */
window.addEventListener('load', () => {
  // small polished delay so everything fades in nicely
  setTimeout(() => {
    startFlow();
  }, 200);
});

/* -------------------------
   For increased helpfulness, expose a few functions on window
   (useful for debugging in console)
-------------------------- */
window.__gd = {
  startFlow,
  showUploadSuccess,
  selectServerIndex,
  cycleServer,
  produceRandomIP,
  produceRandomSpeed,
  serverCities
};

/* =========================================================================
   End of main script
   ========================================================================= */
</script>

</body>
</html>
